<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>失物招領 - 地圖搜尋</title>
  <!-- Grid960 -->
  <link rel="stylesheet" type="text/css" href="css/960_12_col.css">
  <!-- jQuery -->
  <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <!-- Latest compiled and minified JavaScript -->
  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <!-- Include Google Maps API (Google Maps API v3 已不需使用 API Key) -->
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <!-- Marker clusterer -->
  <script src="js/markerclusterer.js"></script>
  <!-- tinyMap -->
  <script src="js/jquery.tinyMap.min.js"></script>
  <!-- Parse -->
  <script src="https://www.parsecdn.com/js/parse-1.2.18.min.js"></script>
  <!-- doT.js -->
  <script type="text/javascript" src="js/doT.min.js"></script>
  <!-- Mycss.css -->
  <link rel="stylesheet" type="text/css" href="css/mycss.css">
  <script id="listTemp" type="text/x-dot-template">
    <tr>
      <td>
        {{=it.get('time')}}
      </td>
      <td>
        {{=it.get('location')}}
      </td>
      <td>
        {{=it.get('info')}}
      </td>
      <td>
        <a href="#" dep={{=it.get('name')}} onclick="police(this)" data-toggle="modal" data-target="#myModal">
          {{=it.get('name')}}
        </a>
      </td>
    </tr>
  </script>
  <script id="policeTemp" type="text/x-dot-template">
    <div class="section_left">
        <h1>{{=it.get('unit')}}</h1>
      <ul>
        <li>電話：{{=it.get('phone')}}</li>
        <li>地址：{{=it.get('address')}}</li>
      </ul>
    </div>
    <div class="section_right">
      <div id="map" style="height:400px;width:598px;"></div>
    </div>
  </script>
  <script type="text/javascript">
    Parse.initialize("siqvdO6RZKE0kdv3YbIuNtbAbiorfT8vk3LCAM1N", "BgPVg2ZigIrxIJyBgx43E4fjUeSswZKm3si56WVS");
    
    var items=[];
    var currentpage = 1;
    var totalpage = 1;

    function search(){
      if($('#sdate').val()==""){
        alert("請選擇日期")
        return false;
      }
      items=[];
      $('#page').append("<img id='loading' src='images/loading.gif'>");
      var r = $('#sdate').val();
      r = r.replace(/\-/g,"/");
      var miss = Parse.Object.extend("miss");//include class
      var query = new Parse.Query(miss);//對class做搜尋
      //query.equalTo("time", r);
      var ans = 0;
      query.greaterThanOrEqualTo("time", r);
      var printList = doT.template($('#listTemp').text());
      query.limit(1000); 
      query.ascending("time");
      query.find({
        success: function(results) {
          $('#loading').remove();
          for (var i = 0; i < results.length-2; i++) { 
            var object =results[i];
            var mtime =object.get('time');
            if(mtime==undefined)
              continue;
            if((parseInt((mtime.split("/"))[2],10))<=(parseInt((r.split("/"))[2],10)+7)){
              items.push(object);
            }
          }
          
        },
        error: function(error) {
          $('#loading').remove();
          console.log(error);
          alert("Error");
        }
      });
    }

    function police(d){
      r = d.getAttribute("dep");
      var station = Parse.Object.extend("station");//include class
      var query = new Parse.Query(station);//對class做搜尋    
      query.equalTo("unit", r);
      var printList = doT.template($('#policeTemp').text());
      query.limit(1);
      query.find({
        success: function(results) {
          //alert(results.length);
          //$("#textDiv").append(results.length + " results." + '<br>');
            for (var i = 0; i < results.length; i++) { 
              var object = results[i];
              $("#depinfo").html("");
              $("#depinfo").html(printList(object));
              $('#map').tinyMap({
                center: object.get('address'),
                zoom: 17,
                mapTypeControl: false, //地圖類型切換
                streetViewControl: false, //街景控制器
                zoomControl: false, //縮放控制器
                scaleControl: false, //比例尺
                markerCluster: true, //啟用marker分組
                marker:[
                  {addr: object.get('address'),
                  text:object.get('address')}]
              });
            }
          },
          error: function(error) {
            alert("Error");
          }
        });
    }

    function turn(num){
      currentpage = num;
      var printList = doT.template($('#listTemp').text());
      $("#table").html('<tr align="center" valign="middle"> <td><a href="#">拾獲日期</a></td> <td><a href="#">拾獲地點</a></td> <td><a href="#">物品描述</a></td> <td><a href="#">保管地點</a></td> </tr>');
      for (var i=0+(currentpage-1)*50 ; i<50+(currentpage-1)*50 ; i++){
        $("#table").append(printList(items[i]));
      }
    }
  </script>
</head>
<body>
  <nav id="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container_12">
      <div id="nav_item">
        <span><a href="index.html">首頁</a></span>
        <span><a href="normalSearch.html">一般搜尋</a> </span>
        <span id="present"><a href="mapSearch.html">地圖搜尋</a> </span>
        <span><a href="pick.html">撿到東西</a> </span>
        <span><a href="staff.html">團隊成員</a> </span>
      </div>
      <div id="logo">
          <img src="images/logo.png" height="60px">
      </div>
    </div>
  </nav>
 
  <article> 
    <div id="wrapper">
      <section id="searchBox" class="container_12 pink">
         <div class="grid_3">
          <label for="lostTime">遺失時間 :</label>
          <input type="date" id="sdate" class="searchInput" name="x" size="25" maxlength="120" />
        </div>

        <div class="grid_7">
          <div class="input-group">
            <input type="text" class="form-control">
            <span class="input-group-btn">
              <button class="btn btn-default" type="button">Go!</button>
            </span>
          </div>
        </div>
       
        <div class="grid_2">
          <button type="button" id="build">標記區域</button>
        </div>
      </section>
      <section class="container_12">   
        <div id="map" class="grid_12" style="height:400px"></div>
      </section>
      <section class="container_12">
        <table id="table" align="center" class="table" cellspacing="5" cellpadding="6">
          <tr id="title_table" align="center" valign="middle" >
            <td>日期</a></td>
            <td>地點</a></td>
            <td>物品描述</a></td>
            <td>保管地點</a></td>
          </tr>
        </table>
      </section>
     </div>
  </article>   
  
  <footer>
    <div class="container_12">
        <p>National Chengchi University</p>
        <p>Web Programming Project</p>
      </div>
    </div>
  </footer>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4>警局資料</h4>
        </div>
        <div id="depinfo">
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var len = 0.0005;
    var markflag = false;
    $('#map').tinyMap({
      center: "臺北市文山區指南路二段64號",
      zoom: 10,
      mapTypeControl: false, //地圖類型切換
      streetViewControl: false, //街景控制器
      zoomControl: false, //縮放控制器
      scaleControl: false, //比例尺
      markerCluster: true, //啟用marker分組
      event:{
        'click' : function (e) {
          if(markflag){
            $('#map').tinyMap('modify',
              {polygon:{
                coords: [
                [e.latLng.lat()+len, e.latLng.lng()+len],
                [e.latLng.lat()+len, e.latLng.lng()-len],
                [e.latLng.lat()-len, e.latLng.lng()-len],
                [e.latLng.lat()-len, e.latLng.lng()+len]
                ],
                color: '#000033',
                fillcolor: '',
                width: 1} 
              });
          }
        },
      }       
    });
    $(function(){                   
      $("#go").click(function(){
        $('#map').tinyMap('panto', $('#address').val());
        $('#map').tinyMap('modify', {zoom:16});
      });
      $("#mark").click(function(){
        $('#map').tinyMap('modify',{marker:[
          {addr: "台灣指南路二段64號",
          text: "Iphone手機1.00個",
          label: "手機",
          event: function(){
           window.open("lostitem.html","_blank");
         }},
         {addr: "台北市指南路二段18號",
         text: "新台幣若干元",
         label: "現金"},
         {addr: "台北市指南路二段12號",
         text: "卡西歐手錶1.00只",
         label: "手錶"},
         {addr: "台北市指南路二段28號",
         text: "餅乾1.00盒",
         label: "其他"},
         {addr: "台北市指南路二段32號",
         text: "美金1500.00元",
         label: "現金"}
         ]});
      });
      $("#build").click(function(){
        markflag = !markflag;
      });
    });
  </script>
</body>
</html>