<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>失物招領 - 地圖搜尋</title>
  <link rel="shortcut icon" href="images/icon.ico" />
  <!-- Grid960 -->
  <link rel="stylesheet" type="text/css" href="css/960_12_col.css">
  <!-- jQuery -->
  <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <!-- Latest compiled and minified JavaScript -->
  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <!-- Include Google Maps API (Google Maps API v3 已不需使用 API Key) -->
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <!-- Marker clusterer -->
  <script src="http://app.essoduke.org/tinyMap/markerclusterer.js"></script>
  <!-- tinyMap -->
  <script src="js/jquery.tinyMap.min.js"></script>
  <!-- Parse -->
  <script src="https://www.parsecdn.com/js/parse-1.2.18.min.js"></script>
  <!-- doT.js -->
  <script type="text/javascript" src="js/doT.min.js"></script>
  <!-- google jsapi -->
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=true_or_false"></script>
  <!-- Mycss.css -->
  <link rel="stylesheet" type="text/css" href="css/mycss.css">
  <script id="listTemp" type="text/x-dot-template">
    <tr>
      <td>
        {{=it.get('time')}}
      </td>
      <td>
        {{=it.get('location')}}
      </td>
      <td>
        {{=it.get('info')}}
      </td>
      <td>
        <a href="#" dep={{=it.get('name')}} onclick="police(this)" data-toggle="modal" data-target="#myModal">
          {{=it.get('name')}}
        </a>
      </td>
    </tr>
  </script>
  <script id="policeTemp" type="text/x-dot-template">
    <div class="section_left">
        <h1>{{=it.get('unit')}}</h1>
      <ul>
        <li>電話：{{=it.get('phone')}}</li>
        <li>地址：{{=it.get('address')}}</li>
      </ul>
    </div>
    <div class="section_right">
      <div id="mapPolice" style="height:400px;width:598px;"></div>
    </div>
  </script>
  <script type="text/javascript">
    Parse.initialize("siqvdO6RZKE0kdv3YbIuNtbAbiorfT8vk3LCAM1N", "BgPVg2ZigIrxIJyBgx43E4fjUeSswZKm3si56WVS");
    
    var items=[];
    var policelist=[];
    var markerlist=[];
    var currentpage = 1;
    var totalpage = 1;

    function search(){
      if($('#sdate').val()==""){
        alert("請選擇日期")
        return false;
      }
      items=[];
      $("#table").html('<tr id="title_table" align="center" valign="middle" ><td style="width:100px">日期</a></td><td style="width:200px">地點</a></td><td>物品描述</a></td><td style="width:100px">保管地點</a></td></tr>');
      $('#table').append("<tr><td colspan='4'> <img id='loading' src='images/loading.gif'> </td></tr>");
      var r = $('#sdate').val();
      r = r.replace(/\-/g,"/");
      var miss = Parse.Object.extend("new");//include class
      var query = new Parse.Query(miss);//對class做搜尋
      //query.equalTo("time", r);
      var ans = 0;
      query.greaterThanOrEqualTo("time", r);
      var printList = doT.template($('#listTemp').text());
      query.limit(1000); 
      query.ascending("time");
      query.find({
        success: function(results) {
          $('#loading').remove();
          for (var i = 0; i < results.length-2; i++) { 
            var object =results[i];
            var mtime =object.get('time');
            var mloc =object.get('location');
            var minfo =object.get('info');
            if(mtime==undefined||mloc==undefined||minfo==undefined)
              continue;
            if((parseInt((mtime.split("/"))[2],10))<=(parseInt((r.split("/"))[2],10)+7)){
              if(mloc.search($('#sloc').val())!=-1 && minfo.search($('#sname').val())!=-1){
                items.push(object);
              }
            }
          }

          if(items.length==0){
            $('#table').append("<tr><td colspan='4' style='font-size:2em;pading-top:20px'> 無此時間區段遺失物資料 </td></tr>");
          }
        },
        error: function(error) {
          $('#loading').remove();
          console.log(error);
          alert("Error");
        }
      });
    }


    function police(d){
      r = d.getAttribute("dep");
      var station = Parse.Object.extend("station");//include class
      var query = new Parse.Query(station);//對class做搜尋    
      query.equalTo("unit", r);
      var printList = doT.template($('#policeTemp').text());
      query.limit(1);
      query.find({
        success: function(results) {
          //alert(results.length);
          //$("#textDiv").append(results.length + " results." + '<br>');
            for (var i = 0; i < results.length; i++) { 
              var object = results[i];
              $("#depinfo").html("");
              $("#depinfo").html(printList(object));
              $('#mapPolice').tinyMap({
                center: object.get('address'),
                zoom: 17,
                mapTypeControl: false, //地圖類型切換
                streetViewControl: false, //街景控制器
                zoomControl: false, //縮放控制器
                scaleControl: false, //比例尺
                markerCluster: true, //啟用marker分組
                marker:[
                  {addr: object.get('address'),
                  text:object.get('address')}]
              });
            }
          },
          error: function(error) {
            alert("Error");
          }
        });
    }

    function mark(x,y){
      var pyrmont = new google.maps.LatLng(x,y);;
      map = new google.maps.Map(document.getElementById('map1'), {
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          center: pyrmont,
          zoom: 15
      });
      var request = {
        location: pyrmont,
        radius: '300',
        types: ['police']
      };

      service = new google.maps.places.PlacesService(map);
      service.search(request, callback);
      
      function callback(results, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
          $('#map').tinyMap('clear', 'marker');
          results.forEach(function(r){
            if($.inArray(r.name,policelist)==-1)
              policelist.push(r.name);
            if($.inArray({addr: [r.geometry.location.k,r.geometry.location.A],text: r.name},markerlist)==-1)
              markerlist.push({addr: [r.geometry.location.k,r.geometry.location.A],text: r.name});
          });
          $('#map').tinyMap('modify',{marker:markerlist,markerCluster: true});
          var printList = doT.template($('#listTemp').text());
          $("#table").html('<tr id="title_table" align="center" valign="middle" ><td style="width:100px">日期</a></td><td style="width:200px">地點</a></td><td>物品描述</a></td><td style="width:100px">保管地點</a></td></tr>');
          for(var i=0 ; i<items.length ; i++){
            polname = items[i].get('name');
            if($.inArray(polname,policelist)!=-1){
              $("#table").append(printList(items[i]));
            }
          }
        }
      }  
    }
  </script>
</head>
<body>
  <nav id="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container_12">
      <div id="nav_item">
        <span><a href="index.html">首頁</a></span>
        <span><a href="normalSearch.html">一般搜尋</a> </span>
        <span id="present"><a href="mapSearch.html">地圖搜尋</a> </span>
        <span><a href="pick.html">撿到東西</a> </span>
        <span><a href="staff.html">團隊成員</a> </span>
      </div>
      <div id="logo">
          <img src="images/logo.png" height="60px">
      </div>
    </div>
  </nav>
 
  <article> 
    <div id="wrapper">
      <section class="container_12">
        <div class="grid_12" style="text-align:center">
          <p>請先選擇遺失時間，利用搜尋列移動至可能遺失地，點選標記區域按鈕，點選地圖後將列出範圍內警局所保管遺失物資料。</p>
        </div>
      </section>
      <section id="searchBox" class="container_12 pink">
        <div class="grid_3">
          <label for="lostTime">遺失時間 :</label>
          <input type="date" id="sdate" class="searchInput" name="x" size="25" maxlength="120" />
        </div>

        <div class="grid_7">
          <div class="input-group">
            <input type="text" class="form-control" id="address">
            <span class="input-group-btn">
              <button class="btn btn-default" type="button" id="go">Go!</button>
            </span>
          </div>
        </div>
       
        <div class="grid_2">
          <button type="button" id="build" style="width:100%">標記區域</button>
        </div>
      </section>
      <section class="container_12">   
        <div id="map" class="grid_12" style="height:400px"></div>
        <div id="map1" style="display:none;"></div>
      </section>
      <section class="container_12">
        <table id="table" class="table" cellspacing="5" cellpadding="6">
          <tr id="title_table" align="center" valign="middle" >
            <td style="width:100px">日期</a></td>
            <td style="width:200px">地點</a></td>
            <td>物品描述</a></td>
            <td style="width:100px">保管地點</a></td>
          </tr>
        </table>
      </section>
     </div>
  </article>   
  
  <footer>
    <div class="container_12">
        <p>National Chengchi University</p>
        <p>Web Programming Project</p>
      </div>
    </div>
  </footer>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4>警局資料</h4>
        </div>
        <div id="depinfo">
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var markflag = false;
    $('#map').tinyMap({
      center: "臺北市文山區指南路二段64號",
      zoom: 10,
      mapTypeControl: false, //地圖類型切換
      streetViewControl: false, //街景控制器
      zoomControl: false, //縮放控制器
      scaleControl: false, //比例尺
      markerCluster: true, //啟用marker分組
      event:{
        'click' : function (e) {
          if(markflag){
            $('#map').tinyMap('modify',
              {circle : [{
                center: {x: e.latLng.lat(), y: e.latLng.lng()},
                radius: 300,
                color: '#000033',
                fillcolor: ''
              }]
            });
            mark(e.latLng.lat(),e.latLng.lng());
          }
        }
      }
    });
    $(function(){                   
      $("#go").click(function(){
        $('#map').tinyMap('panto', $('#address').val());
        $('#map').tinyMap('modify', {zoom:16});
      });
      $("#build").click(function(){
        if($('#sdate').val()==""){
          alert("請選擇日期");
        }
        else{
         markflag = !markflag;
        }
      });
      $("#sdate").change(function(){
        $('#map').tinyMap('clear', 'marker,circle');
        markerlist = [];
        policelist = [];
        markflag = false;
        search();
      });
    });
  </script>
</body>
</html>